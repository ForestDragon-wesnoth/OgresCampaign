#textdomain wesnoth-NCoSS
{~add-ons/1The_Great_Steppe_Era/utils/ai.cfg}

#define NOCC_CITY_LEFT
x,y=17,32
radius=3
#enddef

#define NOCC_CITY_MIDDLE
x,y=37,26
radius=3
#enddef

#define NOCC_CITY_RIGHT
x,y=58,28
radius=3
#enddef


#define NCOSS_S4_CITY_LOCATIONS
{NOCC_CITY_LEFT}
[or]
{NOCC_CITY_MIDDLE}
[/or]
[or]
{NOCC_CITY_RIGHT}
[/or]
#enddef

[scenario]
    id=4_Time_to_Preach
    name=_ "Time to Preach"
    random_start_time=no
    allow_new_game=yes
    force_lock_settings=yes
    experience_modifier=100
#    next_scenario=4_Time_to_Preach
    map_data="{~add-ons/Northern_Crusade_of_Shrogg_Stoneface/maps/4_Time_to_Preach.map}"
    carryover_percentage=0
    carryover_add=no
    {TURNS 30 27 25}
#ifdef STEPPE_MUSIC
#    {SCENARIO_MUSIC battlecry.ogg}
#    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
#    {EXTRA_SCENARIO_MUSIC loyalists.ogg}
#else
#    {SCENARIO_MUSIC siege_of_laurelmor.ogg}
#    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
#    {EXTRA_SCENARIO_MUSIC loyalists.ogg}
#endif

    {DEFAULT_SCHEDULE}
    
    [story]
        [part]
            story= _ "TODO"
        [/part]
    [/story]
    
    [side]
        controller=human
        id=Pan
        type=Kingdom_Pan
        side=1
        save_id=Pan
        canrecruit=yes
        gold=400
        village_support=2
        recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        team_name=ogres
        user_team_name= _ "Ogres"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=red
#        fog=yes
#        shroud=yes
        share_vision=all
    [/side]
    [side]
        controller=human
        id=Brother
        type=Kingdom_Pan
        side=2
        save_id=Brother
        canrecruit=yes
        gold=400
        village_support=2
        recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        team_name=ogres
        user_team_name= _ "Ogres"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=blue
#        fog=yes
#        shroud=yes
        share_vision=all
    [/side]
    [side]
        controller=ai
        side=3
        canrecruit=yes
        {GOLD 300 375 450}
        income={ON_DIFFICULTY 20 25 30}
        village_gold=3
        village_support=2
        id=enemy_leader
        type=Slav_Luminary
        recruit=Slav_Skylark,Slav_Messenger_of_Light,Slav_Marksman,Slav_Woodsman,Slav_Guard,Slav_Knyaz_Warrior,Slav_Architect,Slav_Messenger_of_Light,Slav_Jouster,Slav_Ushkuynik
        team_name=krad
        user_team_name= _ "Krad"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=orange
        [ai]
            {SLAV_AI}
            passive_leader=yes
            #tries to target priests:
            [goal]
                name=target
                [criteria]
                    type_adv_tree=Kingdom_Cleric
                [/criteria]
                value=5.0
            [/goal]
        [/ai]
    [/side]
#waiting side, for the wave units who shouldn't be attacking yet, so they don't waste upkeep for the side, and also it's easier to make them no longer act as guardians:
    [side]
        controller=ai
        side=4
        no_leader=yes
        gold=0
        income=0
        hidden=yes
        team_name=krad
        user_team_name= _ "Krad"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=white#orange#purple
        [ai]
            {SLAV_AI}
            [avoid]
                [not]
                    x,y=36,7
                    radius=6
                [/not]
            [/avoid]
        [/ai]
    [/side]

    [side]
        controller=ai
        side=5
        no_leader=yes
        gold=0
        income=5
        team_name=ogres,krad
        user_team_name= _ "Neutral"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=brown
        [ai]
            {SLAV_AI}
        [/ai]
    [/side]
    [event]
        name=prestart
        {SCATTER_UNITS 5 Slav_Worker 1 (
            {NOCC_CITY_LEFT}
            [and]
                [not]
                    [filter]
                    [/filter]
                [/not]
            [/and]
        ) (
            side=5
            generate_name=yes
            random_traits=yes
        )}        
        {SCATTER_UNITS 5 Slav_Worker 1 (
            {NOCC_CITY_RIGHT}
            [and]
                [not]
                    [filter]
                    [/filter]
                [/not]
            [/and]
        ) (
            side=5
            generate_name=yes
            random_traits=yes
        )}        
        {SCATTER_UNITS 10 Slav_Worker 1 (
            {NOCC_CITY_MIDDLE}
            [and]
                [not]
                    [filter]
                    [/filter]
                [/not]
            [/and]
        ) (
            side=5
            generate_name=yes
            random_traits=yes
        )}        

#wave 1 is relatively weak units, wave 2 could be lvl2s with a couple lvl3s, wave 3 could be more lvl3-heavy

        {SCATTER_UNITS 10 Slav_Archer,Slav_Militia,Slav_Apprentice,Slav_Watchman,Slav_Skylark,Slav_Marksman,Slav_Woodsman,Slav_Guard,Slav_Knyaz_Warrior,Slav_Architect,Slav_Messenger_of_Light,Slav_Jouster,Slav_Ushkuynik 1 (
        [not]
            [filter]
            [/filter]
        [/not]
        [and]
            x,y=36,9
            radius=6
        [/and]
        ) (
            side=4
            generate_name=yes
            random_traits=yes
            [modifications]
                [object]
                    silent=yes
                    duration=scenario
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=ncoss_s4_wave1#for filtering later
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        )}     

#workers with less than maxed faith go near priests, to make it easier for players to convert them:
        [micro_ai]
            side=5
            ai_type=goto
            action=add
            [filter]
                formula="self.wml_vars.faith < 3"
                [filter_location]
                    [filter]
                        ability=steppe_sermon
                    [/filter]
                    radius=3
                [/filter_location]
            [/filter]
            [filter_location]
                [filter]
                    ability=steppe_sermon
                [/filter]
                radius=1
            [/filter_location]
            ca_score=150000
            unique_goals=yes
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=goto
            action=add
            [filter]
                formula="self.wml_vars.faith < 3"
                [filter_location]
                    [not]
                        {NCOSS_S4_CITY_LOCATIONS}
                    [/not]
                [/filter_location]
            [/filter]
            [filter_location]
                {NCOSS_S4_CITY_LOCATIONS}
            [/filter_location]
            ca_score=50000
            unique_goals=yes
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=stationed_guardian
            action=add

            id=stationed1
            distance=7
            station_x,station_y=2,14
            guard_x,guard_y=36,7
        [/micro_ai]

        [micro_ai]
            side=4
            ai_type=zone_guardian
            action=add
            id=ncoss_guards
            [filter_location]
                x,y=36,7
                radius=6
            [/filter_location]
        [/micro_ai]

#ai tries to move towards civilians, to recruit them
        [micro_ai]
            side=3
            ai_type=goto
            action=add
            [filter]
                [filter_location]
                    [filter]
                        side=5
                        formula="self.wml_vars.faith < 3"
                    [/filter]
                [/filter_location]
                radius=9#only ai units close enough to civilians go towards them, otherwise it would take a long time to calculate with the size of the map
            [/filter]
            [filter_location]
                [filter]
                    side=5
                    formula="self.wml_vars.faith < 3"
                [/filter]
                radius=1
            [/filter_location]
            ca_score=50000
            unique_goals=yes
        [/micro_ai]

        {VARIABLE ncoss_s4_villagers_required {ON_DIFFICULTY 15 18 20}}#numbers are placeholder-y, can be changed later

        [objectives]
            [objective]
                condition=win
                description= _ "Kill the enemy leader"
            [/objective]
            [objective]
                condition=win
                description= _ "Convert $ncoss_s4_villagers_required| villagers to max faith ($ncoss_s4_serfs|/$ncoss_s4_villagers_required|)"
                [show_if]
                    {VARIABLE_CONDITIONAL ncoss_s4_serfs less_than $ncoss_s4_villagers_required|}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of any of your leaders"
                condition=lose
            [/objective]
            [objective]
                description= _ "There isn't enough villagers (including those still in villages) to convert (currently $potential_villagers|/$ncoss_s4_villagers_required|)"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=no
                carryover_percentage=0
            [/gold_carryover]

            [note]
                description=_ "You need to complete both objectives to win"
            [/note]
            [note]
                description=_ "To convert villagers, have a cleric (or his advancements) stand next to the villagers"
            [/note]
            [note]
                description=_ "You can capture villages to spawn a villager (works once per village). Villages that already spawned a peasant will be marked with an 'X' label."
            [/note]
            [note]
                description=_ "If enemies move next to a faithless villager, he will join the enemy side and turn into a lvl1 unit"
            [/note]
            #this is to make the variable update
            delayed_variable_substitution=yes
        [/objectives]
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=5
                formula="self.wml_vars.faith >= 3"
            [/filter]
            variable=faithful_villagers
            kill=no
        [/store_unit]

        [foreach]
            array=faithful_villagers
            index_var=e
            [do]
                {IF_VAR this_item.type equals Slav_Worker (
                [then]
                    {TRANSFORM_UNIT id=$this_item.id Kingdom_Serf}
                [/then]
                )}    
            [/do]
        [/foreach]
        {VARIABLE ncoss_s4_serfs $faithful_villagers.length}
        {CLEAR_VARIABLE faithful_villagers}

        [store_locations]
            terrain=*^V*
            [not]
                find_in=ncoss_s4_captured_villages
            [/not]
            variable=tmp_available_villages
        [/store_locations]
        [store_unit]
            [filter]
                side=5
            [/filter]
            variable=tmp_total_villagers
            kill=no
        [/store_unit]

        {VARIABLE potential_villagers $tmp_total_villagers.length}
        {VARIABLE_OP potential_villagers add $tmp_available_villages.length}
#        [chat]
#            message="potential villagers: $potential_villagers"
#        [/chat]
        {IF_VAR potential_villagers less_than $ncoss_s4_villagers_required (
        [then]

        [message]
            side=1,2
            canrecruit=yes
            message= _ "Damn it, too many villagers are dead! Now we won't have enough serfs to work on this land..."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
        [/then]
        )}
        {CLEAR_VARIABLE tmp_available_villages}
        {CLEAR_VARIABLE tmp_total_villagers}
    [/event]

    [event]
        name=moveto
        id=ncoss_villagers
        first_time_only=no
        [filter]
            side=1,2
            [filter_location]
                terrain=*^V*
                [not]
                    find_in=ncoss_s4_captured_villages
                [/not]
            [/filter_location]
        [/filter]

        {UNIT 5 Slav_Worker $x1 $y1 (
        generate_name=yes
        random_traits=yes
        animate=yes
        placement=map_passable
        )}
        [store_locations]
            x,y=$x1,$y1
            variable=tmp_villageloc
        [/store_locations]
        [set_variables]
            name=ncoss_s4_captured_villages
            mode=append
            [value]
                x=$x1
                y=$y1
            [/value]
        [/set_variables]
        {CLEAR_VARIABLE tmp_villageloc}
        [label]
            text="X"
            x,y=$x1,$y1
        [/label]
    [/event]
    [event]
        name=moveto
        id=ncoss_arm_villagers
        first_time_only=no
        [filter]
            side=3,4
            [filter_location]
                [filter]
                    side=5
                [/filter]
                radius=1
            [/filter_location]
        [/filter]
        [store_unit]
            [filter]
                side=5
                [filter_location]
                    x,y=$x1,$y1
                    radius=1
                [/filter_location]
            [/filter]
            variable=armed_villagers
            kill=no
        [/store_unit]

        [foreach]
            array=armed_villagers
            index_var=e
            [do]
                {MODIFY_UNIT id=$this_item.id side 3}
                {ADVANCE_UNIT id=$this_item.id ()}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE armed_villagers}
    [/event]
    [event]
        name=turn 3
        [modify_unit]
            [filter]
                side=4
                ability=ncoss_s4_wave1
            [/filter]
            side=3
        [/modify_unit]
    [/event]

    [event]
        name=die
        [filter]
            id=enemy_leader
        [/filter]

        {IF_VAR ncoss_s4_serfs greater_than_equal_to $ncoss_s4_villagers_required (
        [then]
#TODO: add victory dialog
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 0}
            carryover_report=yes
        [/endlevel]
        [/then]
        [else]

        [message]
            side=$second_unit.side
            canrecruit=yes
            message= _ "Now we should have more time to convert the villagers without being bothered."
        [/message]

#giving the player some extra turns to convert villagers
        [modify_turns]
            add=8
        [/modify_turns]

        [/else]
        )}

        [message]
            side=1,2
            [not]
                side=$second_unit.side
            [/not]
            canrecruit=yes
            message= _ "Very well."
        [/message]
    [/event]
[/scenario]
