#textdomain wesnoth-NCoSS
{~add-ons/1The_Great_Steppe_Era/utils/ai.cfg}

#define NCOSS_REPLACE_WALL_BASE_TERRAIN_DIRT
    [store_unit]
        [filter]
        	ability=walldummy
        [/filter]
        variable=ncoss_tmp_walls
        kill=no
    [/store_unit]
    [foreach]
        array=ncoss_tmp_walls
        index_var=e
        [do]
    {VARIABLE this_item.variables.orig_terrain Re^Edt}

    [unstore_unit]
        variable=this_item
        find_vacant=no
    [/unstore_unit]

    [/do]
    [/foreach]
    {CLEAR_VARIABLE ncoss_tmp_walls}
#enddef

[scenario]
    id=3_Siege
    name=_ "Siege of Shumsk"
    random_start_time=no
    allow_new_game=yes
    force_lock_settings=yes
    experience_modifier=100
    map_data="{~add-ons/Northern_Crusade_of_Shrogg_Stoneface/maps/3_Siege.map}"
    carryover_percentage=20
    carryover_add=yes
    {TURNS 50 48 45}
#ifdef STEPPE_MUSIC
    {SCENARIO_MUSIC battlecry.ogg}
    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
    {EXTRA_SCENARIO_MUSIC loyalists.ogg}
#else
    {SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
    {EXTRA_SCENARIO_MUSIC loyalists.ogg}
#endif

    {DEFAULT_SCHEDULE}
    
    [story]
        [part]
            story= _ "TODO"
        [/part]
    [/story]
    
    [side]
        controller=human
        id=Pan
        type=Kingdom_Pan
        side=1
        save_id=Pan
        canrecruit=yes
        gold=400
        recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        team_name=ogres
        user_team_name= _ "Ogres"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=red
#        fog=yes
        shroud=yes
        share_vision=all
    [/side]
    [side]
        controller=human
        id=Brother
        type=Kingdom_Pan
        side=2
        save_id=Brother
        canrecruit=yes
        gold=400
        recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        team_name=ogres
        user_team_name= _ "Ogres"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=blue
#        fog=yes
        shroud=yes
        share_vision=all
    [/side]
    [side]
        controller=ai
        side=3
        canrecruit=yes
        {GOLD 350 400 450}
        income={ON_DIFFICULTY 3 5 10}
        village_gold=3
        village_support=2
        id=enemy_leader
        type=Slav_Knyaz_Great_Warrior
        recruit=Slav_Archer,Slav_Militia#,Slav_Marksman,Slav_Guard,Slav_Woodsman
        team_name=krad
        user_team_name= _ "Krad"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=teal
        [ai]
            {SLAV_AI}
            passive_leader=yes
            [goal]
                name=target
                [criteria]
                    type=NCoSS_Engineer,NCoSS_Catapult,NCoSS_Battering_Ram
                [/criteria]
                value=5.0
            [/goal]
            #AI stays inside the city
            [avoid]
            	x=0-17
            	[or]
            	    x=42-54
            	[/or]
            	[or]
            	    x=42-54
            	[/or]
            	[or]
            	    y=0-9
            	[/or]
            	[or]
            	    y=26-39
            	[/or]
            [/avoid]
        [/ai]
    [/side]
    [side]
        controller=ai
        side=4
        canrecruit=yes
        no_leader=yes
        team_name=krad
        user_team_name= _ "Krad"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=purple
        [ai]
            {SLAV_AI}
            [goal]
                name=target
                [criteria]
                    type=NCoSS_Engineer,NCoSS_Catapult,NCoSS_Battering_Ram
                [/criteria]
                value=5.0
            [/goal]
        [/ai]
    [/side]
    [side]
        controller=null
        side=5
        no_leader=yes
        gold=0
        income=5
        team_name=ogres,krad
        user_team_name= _ "Neutral"
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        color=black
        [ai]
            {SLAV_AI}
        [/ai]
    [/side]

    [event]
        name=last breath
        [filter]
            id=Pan
            [or]
                id=Brother
            [/or]
        [/filter]
        [message]
            speaker=unit
            message= _ "Uuugh..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

#define NCOSS_SCATTER_BUILDINGS LOCATIONFILTER TYPE
[store_locations]
    {LOCATIONFILTER}
    [not]
    [filter]
    [/filter]
    [/not]
    variable=ncoss_walls
[/store_locations]

{FOREACH ncoss_walls i}

{UNIT 3 {TYPE} $ncoss_walls[$i].x $ncoss_walls[$i].y ()}

#[if]
#[not]
#[have_unit]
#   x,y=$ncoss_walls[$i].x,$ncoss_walls[$i].y
#[/have_unit]
#[/not]
#[then]
#    {UNIT 3 {TYPE} $ncoss_walls[$i].x $ncoss_walls[$i].y ()}
#[/then]
#[/if]

{NEXT i}
{CLEAR_VARIABLE ncoss_walls}
#enddef

    [event]
        name=prestart
        [capture_village]
        	side=3
        	x=18-42
        	y=10-26
        [/capture_village]
        [objectives]
            [objective]
                description= _ "Kill the central enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of any of your leaders"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            [note]
                description=_"Your engineer can build powerful siege weapons on adjacent tiles via a rightclick menu."
            [/note]
            [note]
                description=_"Every few turns, there will be an enemy ambush on the enemy turn (spawning in forests). Keep your engineer and catapults protected, or they could easily get killed."
            [/note]
            [note]
                description=_"Your units can fill water tiles with soil (turning deep water into shallow water, and shallow water into ford) via a rightclick menu (costs moves though)"
            [/note]
            [note]
                description=_"You can hire temsk mercenaries (neutral units in the top-right corner of the map) by moving next to them"
            [/note]
            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]

#remove normal shroud and leave only a custom shroud pattern:
        [remove_shroud]
            side=1,2
            [not]
                x,y=30,17
                radius=2
#                [not]
#                    x,y=30,15
#                    [or]
#                        x,y=30,19
#                    [/or]
#                [/not]
            [/not]
        [/remove_shroud]

        #pre-placed buildings
    
        {UNIT 3 Slav_Fortress 39 22 ()}
        {UNIT 3 Slav_Fortress 41 19 ()}
        {UNIT 3 Slav_Fortress 18 18 ()}
        {UNIT 3 Slav_Fortress 20 21 ()}
        {UNIT 3 Slav_Fortress 29 11 ()}
        {UNIT 3 Slav_Fortress 33 11 ()}


        {NCOSS_SCATTER_BUILDINGS (
            terrain=Ce
            x=16-43
            y=10-25
            include_borders=no
        ) Woodwall}

        {NCOSS_SCATTER_BUILDINGS (
            terrain=Ket
            x=16-43
            y=10-25
            include_borders=no
            [not]
                x,y=19,20
                radius=2
                [or]
                x,y=40,20
                radius=2
                [/or]
                [or]
                x,y=31,11
                radius=2
                [/or]
                [or]
                x,y=30,17
                radius=1
                [/or]
            [/not]
        ) Slav_Outpost}

        {NCOSS_SCATTER_BUILDINGS (
            x=26-34
            y=14-20
#            x,y=30,17
#            radius=3
            include_borders=no
            terrain=Ket
            [not]
               [filter]
                   side=3
                   canrecruit=yes
               [/filter]
               radius=1
           [/not]
        ) Slav_Fortress}

        {NCOSS_SCATTER_BUILDINGS (
            terrain=Ket
            x=16-43
            y=10-25
            include_borders=no
            [not]
                x,y=30,17
                radius=3
            [/not]
        ) Tall_Woodwall}

#removes since they were too strong
#        {GENERIC_UNIT 3 Slav_Workshop 28 17}
#        {GENERIC_UNIT 3 Slav_Workshop 32 17}

#guards
        {UNIT 3 Slav_Grand_Guard 21 19 ()}
        {UNIT 3 Slav_Grand_Guard 31 13 ()}
        {UNIT 3 Slav_Grand_Guard 38 19 ()}

        {SCATTER_UNITS 14 Slav_Guard,Slav_Marksman 1 (
            x=21-38
            y=14-21
            [and]
                [not]
                	[filter]
                	[/filter]
                [/not]
                [not]
                    [filter_adjacent_location]
                        [filter]
                        [/filter]
                    [/filter_adjacent_location]
                [/not]
            [/and]
        ) (
            side=3
            generate_name=yes
            random_traits=yes
        )}

#temsk mercenaries
        {UNIT 5 Slav_Temsk_Champion 51 12 (
        id=temsk_mercenary_leader
        generate_name=yes
        canrecruit=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]
        )}

        {UNIT 5 Slav_Temsk_Ravenblade 50 12 (
        generate_name=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        )}

        {UNIT 5 Slav_Temsk_Ravenblade 52 12 (
        generate_name=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]
        )}

        [label]
            text=_"Temsk Mercenaries"
            x,y=51,12
        [/label]


#another group of temsk mercenaries, closer to the second player
        {UNIT 5 Slav_Temsk_Champion 43 5 (
        id=temsk_mercenary_leader2
        generate_name=yes
        canrecruit=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]
        )}

        {UNIT 5 Slav_Temsk_Ravenblade 43 4 (
        generate_name=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        )}

        {UNIT 5 Slav_Temsk_Ravenblade 42 5 (
        generate_name=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]
        )}

        [label]
            text=_"Temsk Mercenaries"
            x,y=43,5
        [/label]

        [unit_overlay]
               id=temsk_mercenary_leader
               image="misc/leader-expendable.png"
        [/unit_overlay]

        [unit_overlay]
               id=temsk_mercenary_leader2
               image="misc/leader-expendable.png"
        [/unit_overlay]

    [set_menu_item]
        id=ncoss_fill_moat
        description=_"Fill water with soil, costs <span color='#2c9fed'>40%</span> of this unit's moves)"
        image="fillicon.png"
        [show_if]
        [/show_if]

        [filter_location]
            terrain=W*
            [not]
                terrain=Wwf
            [/not]
            [and]
            [filter]
                side=1,2
                formula=($this_unit.moves >= $this_unit.max_moves * 0.4)
                [not]
                    race=mechanical
                [/not]
            [/filter]
            radius=1
            [/and]
        [/filter_location]
        [command]
   [store_unit]
       [filter]
            side=1,2
            formula=($this_unit.moves >= $this_unit.max_moves * 0.4)
            [not]
                race=mechanical
            [/not]
            [filter_location]
                x,y=$x1,$y1
                radius=1
            [/filter_location]
       [/filter]
       variable=able_to_fill
   [/store_unit]

    [if]
    [variable]
        name=able_to_fill.length
        greater_than=0
    [/variable]
    [then]

    {VARIABLE filler_random_limit $able_to_fill.length}
    {VARIABLE_OP filler_random_limit sub 1}
    {RANDOM 0..$filler_random_limit}

#since the array number is offset by one from the length (if there are 2 units, the length is 2, but the units are [0] and [1])

#the exp is calculated based on cost and level
#    {VARIABLE tmp_filler_exp 1}
#    {VARIABLE_OP able_to_fill[$random].experience add $tmp_filler_exp}
    {VARIABLE fillmoves $able_to_fill[$random].max_moves}
    {VARIABLE_OP fillmoves multiply 0.4}
    {VARIABLE_OP able_to_fill[$random].moves sub $fillmoves}

    [unstore_unit]
        variable=able_to_fill[$random]
        find_vacant=no
    [/unstore_unit]

    [sound]
    	name=axe.ogg
    [/sound]
    [delay]
    	time=200
    [/delay]
    [sound]
    	name=mud-fist.ogg
    [/sound]
    [delay]
    	time=200
    [/delay]
    [sound]
    	name=water-blast.wav
    [/sound]

    [if]
    [have_location]
        terrain=Wo*
        x,y=$x1,$y1
    [/have_location]
    [then]
    [terrain]
    terrain=Ww
    x,y=$x1,$y1
    layer=base
    [/terrain]
    [/then]
    [else]
    [terrain]
    terrain=Wwf
    x,y=$x1,$y1
    layer=base
    [/terrain]
    [/else]
    [/if]

    [/then]
    [/if]
    {CLEAR_VARIABLE filler_random_limit}
    {CLEAR_VARIABLE tmp_filler_exp}
    {CLEAR_VARIABLE fillmoves}
        [/command]
    [/set_menu_item]

#ifdef HARD
{VARIABLE tmp_ambush_units 3}
{VARIABLE tmp_side4_unitspawn 6}
#else
{VARIABLE tmp_ambush_units 2}
{VARIABLE tmp_side4_unitspawn 5}
#endif
    {NCOSS_REPLACE_WALL_BASE_TERRAIN_DIRT}

    [/event]
    [event]
        name=start
        [message]
            speaker=Pan
            message= _ "Finally, we reached Shumsk."
        [/message]
        [scroll_to]
            x,y=30,16
        [/scroll_to]
        [lock_view][/lock_view]
        [delay]
            time=1000
        [/delay]
        [unlock_view][/unlock_view]
        [message]
            speaker=Brother
            message= _ "The city looks quite well-fortified, sturdy walls, plenty of ballistas. We'll need powerful siege equipment to capture it."
        [/message]
        [message]
            speaker=Pan
            message= _ "Good thing I hired a wesnothian engineer. He should arrive with his gear soon."
        [/message]
#        {UNIT 1 NCoSS_Engineer 52 39 (
        {UNIT 1 NCoSS_Engineer 36 31 (
        id=engineer1
        generate_name=yes
        random_traits=yes
        )}
#        {MOVE_UNIT id=engineer1 47 32}
        {MOVE_UNIT id=engineer1 29 29}
        [message]
            speaker=engineer1
            message= _ "At your service sir! Remember, as we agreed, the payment will be 28 gold per catapult, and 22 gold per battering ram."
        [/message]

        [message]
            speaker=Brother
            message= _ "I've hired an engineer too."
        [/message]

#        {UNIT 2 NCoSS_Engineer 43 1 (
        {UNIT 2 NCoSS_Engineer 14 6 (
        id=engineer2
        generate_name=yes
        random_traits=yes
        )}
        {MOVE_UNIT id=engineer2 16 10}

        [message]
            speaker=engineer2
            message= _ "Time to turn the enemy walls into rubble, hehe."
        [/message]

        [message]
        	speaker=narrator
            message= _"To build siege weapons, use the rightclick menu on a tile next to your engineer."
        [/message]

        [message]
            speaker=Pan
            message= _ "Time to see which of us will kill the city's commander first."
        [/message]

        [message]
            speaker=Brother
            message= _ "A competition, eh? I like that idea. Let's go!"
        [/message]

        [micro_ai]
            side=4
            ai_type=goto
            action=add
            ca_id=boat

            [filter]
            	ability=ncoss_transport
            [/filter]
            [filter_location]
            	x,y=42,12
                [or]
                	x,y=42,13
                [/or]
                [or]
                	x,y=43,14
                [/or]
                #avoid docking next to occupied bridges
                [not]
                [filter_adjacent_location]
                	[filter]
                	[/filter]
                    adjacent=sw    	
                [/filter_adjacent_location]                	
                [/not]
            [/filter_location]
            ca_score=210001
        [/micro_ai]
    [/event]

#define NCOSS_TEMSK_MECENARY_EVENT X Y
    [event]
        name=moveto
        id=ncoss_temsk_mercenaries{X}{Y}
        first_time_only=no
        [filter]
            side=1,2
            [filter_location]
                [filter]
                    side=5
                [/filter]
                radius=2
            [/filter_location]
            [and]
            [filter_location]
            	x,y={X}.{Y}
                radius=3
            [/filter_location]
            [/and]
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL ncoss_s3_mercs_hired{X}{Y} not_equals yes}
        [/filter_condition]
        [message]
            side=$side_number
            canrecruit=yes
            message= _ "Why aren't you fighting us?"
        [/message]
        [message]
        	x,y={X},{Y}
            message= _ "We're wandering mercenaries, we have no loyalty to Krad. I can offer you a deal - for a mere 95 gold me and my men will fiercely fight for you."
        [/message]
        [store_gold]
            variable=actualgold
            side=$side_number
        [/store_gold]
        {IF_VAR actualgold less_than 95 (
        [then]
        [message]
            side=$side_number
            canrecruit=yes
            message= _ "Can't afford your services right now."
        [/message]
        [message]
        	x,y={X},{Y}
            message= _ "Come back when you've looted some gold then. We'll be staying at this camp in the meantime."
        [/message]
        [/then]
        [else]
        [message]
            side=$side_number
            canrecruit=yes
            message=_"Hmmmm... should I hire them?"
            [option]
                image="icons/coins_copper.png"
                description=_"Yes (costs 95 gold)"
                [command]
                [sound]
                    name=gold.ogg
                [/sound]
    
                [gold]
                    amount=-95
                    side=$side_number
                [/gold]
                [modify_unit]
                    [filter]
                    	side=5
                        [filter_location]
                          	x,y={X}.{Y}
                            radius=3
                        [/filter_location]
                    [/filter]
                    side=$side_number
                [/modify_unit]
                [label]
                    text=""#clears the mercenary label
                    x,y={X},{Y}
                [/label]
                [message]
                    x,y={X},{Y}
                    message= _"(to his men) Alright lads, time to raid Shumsk!"
                [/message]
                [message]
                	speaker=narrator
                    message= _"The mercenary leader can recruit Pagans - berserk units who can also build idols via a rightclick menu. However, the mercenary leader cannot recruit Ogre Kingdom units. Unlike your main leader, the death of the mercenary leader does not count as defeat."
                [/message]
                {VARIABLE ncoss_s3_mercs_hired{X}{Y} yes}

#kinda hacky workaround to make the mercenary leader only recruit pagans
        [disallow_recruit]
        	side=1,2
        	extra_recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        	id=temsk_mercenary_leader,temsk_mercenary_leader2
        [/disallow_recruit]

        [set_extra_recruit]
        	extra_recruit=Kingdom_Cleric,Kingdom_River_Warrior,Kingdom_Noble_Son,Kingdom_Feudal,Kingdom_Halfogre_Outlaw,Kingdom_Troll_Mercenary,Kingdom_Serf,Kingdom_Runner
        	side=1,2
        [/set_extra_recruit]

        [set_extra_recruit]
        	extra_recruit=Slav_Temsk_Pagan
        	id=temsk_mercenary_leader,temsk_mercenary_leader2
        [/set_extra_recruit]

                [/command]
            [/option]
            [option]
                image="attacks/blank-attack.png"
                description=_"No"
                [command]
                    [message]
                     	x,y={X},{Y}
                        message= _"Your loss. If you change your mind, we'll still be staying here for a while."
                    [/message]
                [/command]
            [/option]
        [/message]
        [/else]
        )}
    [/event]
#enddef

{NCOSS_TEMSK_MECENARY_EVENT 51 12}

{NCOSS_TEMSK_MECENARY_EVENT 43 5}


#define NCOSS_AMBUSH_LOCATION_FILTER RADIUS
        [not]
        	[filter]
        	[/filter]
        [/not]
        [not]
            [filter_adjacent_location]
                [filter]
                [/filter]
            [/filter_adjacent_location]
        [/not]

        [and]
        [filter]
            type=NCoSS_Engineer,NCoSS_Catapult,NCoSS_Battering_Ram
        [/filter]
        radius={RADIUS}
        [/and]
#enddef

#define NCOSS_USHKUYNIK_AMBUSH
    [if]
    [have_location]
        {NCOSS_AMBUSH_LOCATION_FILTER 5}
        count=3-99999
    [/have_location]
    [then]
    {SCATTER_UNITS $tmp_ambush_units Slav_Ushkuynik 1 (
        {NCOSS_AMBUSH_LOCATION_FILTER 5}
    ) (
        side=4
        generate_name=yes
        random_traits=yes
        animate=yes
    )}
    [/then]
    [else]
#if can't place in a 5-tile radius, try to place in a 7-tile radius instead
    {SCATTER_UNITS $tmp_ambush_units Slav_Ushkuynik 1 (
        {NCOSS_AMBUSH_LOCATION_FILTER 7}
    ) (
        side=4
        generate_name=yes
        random_traits=yes
        animate=yes
    )}
    [/else]
    [/if]
#enddef
#scrapped for now, as it was a bit too brutal
#    [event]
#        name=side 4 turn 3
#        {NCOSS_USHKUYNIK_AMBUSH}
#        [message]
#            type=Slav_Ushkuynik
#            side=4
#            message= _ "Alright men, time to tear the catapults apart! And make sure to kill the wesnothian mercenaries as well."
#        [/message]
#        [message]
#            speaker=Pan
#            message= _ "Damn it, and ambush! Protect the engineer and the siege weapons at all costs!"
#        [/message]
#    [/event]
#    [event]
#        name=side 4 turn 7,side 4 turn 11,side 4 turn 15,side 4 turn 19,side 4 turn 23,side 4 turn 27,side 4 turn 31,side 4 turn 35,side 4 turn 39,side 4 turn 43,sid#e 4 turn 47
#        first_time_only=no
#        {NCOSS_USHKUYNIK_AMBUSH}
#    [/event]

    [event]
        name=side 4 turn
        first_time_only=no
        {VARIABLE_OP ncoss_s3_spawn_timer add 1}
        {IF_VAR ncoss_s3_spawn_timer greater_than_equal_to 4 (
        [then]

        {VARIABLE ncoss_s3_spawn_timer 0}

        {SCATTER_UNITS $tmp_side4_unitspawn Slav_Archer,Slav_Militia,Slav_Watchman 1 (
            x=0-33
            y=26-39
            [or]
            x=0-18
            y=17-39
            [/or]
            [and]
            	terrain=*^F*
                [not]
                	[filter]
                	[/filter]
                [/not]
                [not]
                    [filter_adjacent_location]
                        [filter]
                        [/filter]
                    [/filter_adjacent_location]
                [/not]
            [/and]
        ) (
            side=4
            generate_name=yes
            random_traits=yes
            animate=yes
        )}

        {IF_VAR ncoss_s3_seen_peasants not_equals yes (
        [then]
            [message]
                speaker=Pan
                message= _ "Hmph, the retreating villagers are back with reinforcements. Another nuisance to deal with..."
            [/message]
            {VARIABLE ncoss_s3_seen_peasants yes}
        [/then]
        )}

        [/then]
        )}
    [/event]
#    [event]
#        name=side 4 turn 9,side 4 turn 18,side 4 turn 27
#        {UNIT 4 Boat 53 1 (
#        id=reinforcement_boat
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        {MOVE_UNIT id=reinforcement_boat 42 12}
#
#        {UNIT 4 Boat 53 1 (
#        id=reinforcement_boat2
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        {MOVE_UNIT id=reinforcement_boat2 42 13}
#
#        {UNIT 4 Boat 53 1 (
#        id=reinforcement_boat3
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        {MOVE_UNIT id=reinforcement_boat3 43 14}
#
#        {UNIT 4 Slav_Ushkuynik 41 13 (
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        {UNIT 4 Slav_Ushkuynik 41 14 (
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        {UNIT 4 Slav_Ushkuynik 42 14 (
#        generate_name=yes
#        random_traits=yes
#        animate=yes
#        )}
#        [kill]
#        	id=reinforcement_boat,reinforcement_boat2,reinforcement_boat3
#        	animate=no
#        	fire_event=no
#        [/kill]
#    [/event]
    [event]
        name=side 4 turn
        first_time_only=no
        {VARIABLE_OP ncoss_s3_boat_timer add 1}

        {IF_VAR ncoss_s3_boat_timer greater_than_equal_to 4 (
        [then]

        {VARIABLE ncoss_s3_boat_timer 0}


        {REPEAT 3 (
        {UNIT 4 NCoSS_Longboat 53 1 (
        generate_name=yes
        random_traits=yes
        animate=yes
        placement=map_passable
        )}
        )}

        {IF_VAR ncoss_s3_seen_peasants not_equals yes (
        [then]
            [message]
                speaker=Brother
                message= _ "Look, there's boats with enemy reinforcements! We should try to stop them, or we'll have to fight a lot more enemies..."
            [/message]
            {VARIABLE ncoss_s3_seen_peasants yes}
        [/then]
        )}

        [/then]
        )}
    [/event]
#define NCOSS_TRANSPORT_DEPLOY PORT_X PORT_Y DEPLOY_X DEPLOY_Y
    [event]
    	name=moveto
    	first_time_only=no
        [filter]
            ability=ncoss_transport
            [filter_location]
            	x,y={PORT_X},{PORT_Y}
            [/filter_location]
        [/filter]
        {VARIABLE_OP ncoss_boat_unit rand (Slav_Marksman,Slav_Woodsman,Slav_Guard,Slav_Ushkuynik,Slav_Ushkuynik)}
        {UNIT $unit.side $ncoss_boat_unit {DEPLOY_X} {DEPLOY_Y} (
        generate_name=yes
        random_traits=yes
        animate=yes
        placement=map_passable
        )}
        [kill]
        	id=$unit.id
        	animate=no
        	fire_event=no
        [/kill]
    [/event]
#enddef
    {NCOSS_TRANSPORT_DEPLOY 42 12 41 13}
    {NCOSS_TRANSPORT_DEPLOY 42 13 41 14}
    {NCOSS_TRANSPORT_DEPLOY 43 14 42 14}


    [event]
        name=moveto
        id=ncoss_guards
        [filter]
            side=1,2
            [filter_location]
                [filter]
                	id=enemy_leader
                [/filter]
                radius=3
            [/filter_location]
        [/filter]
        [message]
            speaker=enemy_leader
            message= _ "The invaders have entered the citadel! Time for our last stand!"
        [/message]

        {UNIT 3 Slav_Guard 28 16 ()}
        {UNIT 3 Slav_Guard 32 16 ()}
        {UNIT 3 Slav_Guard 30 19 ()}

    [/event]

    [event]
        name=last breath
        [filter]
            id=enemy_leader
        [/filter]
        [message]
            speaker=unit
            message= _ "And so the city falls..."
        [/message]
    [/event]
    [event]
        name=die
        [filter]
            id=enemy_leader
        [/filter]
        [message]
            side=$second_unit.side
            canrecruit=yes
            message= _ "Yes! The glory of conquest is mine!"
        [/message]

        [message]
            side=1,2
            [not]
                side=$second_unit.side
            [/not]
            canrecruit=yes
            message= _ "Very well."
        [/message]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 20}
            carryover_report=yes
        [/endlevel]
    [/event]
[/scenario]
